<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>MyMiniMAL++</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Intégration de Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght@600&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Remplacez par votre URL Supabase et votre clé publique (anon key)
    const supabaseUrl = 'https://kzdrlgwukhxkkyaahhcq.supabase.co'; // Trouvez cette URL dans Supabase > Settings > API
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6ZHJsZ3d1a2h4a2t5YWFoaGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUwNTg3NDMsImV4cCI6MjA1MDYzNDc0M30.71NDJy8K3ASeVNz6_AYbHLzJ0M7QdTP0CWeJi-OEux0'; // Trouvez cette clé dans Supabase > Settings > API
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
  </script>


<style>
  /****************************************************
   *                  BASE / RESET                    *
   ****************************************************/
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Roboto', sans-serif;
  }

  html,
  body {
    height: 100%;
    display: flex;
    flex-direction: column;
    background: var(--bg-color);
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
  }

  :root {
    /* Palette de couleurs harmonieuse et moderne basée sur Material Design */
    --bg-color: #F5F5F5;
    /* Gris très clair */
    --text-color: #212121;
    /* Noir foncé */
    --text-secondary: #757575;
    /* Gris moyen */
    --card-background: #FFFFFF;
    /* Blanc pour les cartes */
    --accent-color: #3F51B5;
    /* Bleu Indigo */
    --accent-hover: #303F9F;
    /* Bleu Indigo foncé pour le hover */
    --header-bg: #FFFFFF;
    /* Blanc pour l'en-tête */
    --header-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    --filter-bg: #ffffff;
    /* Gris clair pour les filtres */
    --modal-overlay: rgba(0, 0, 0, 0.5);
    --delete-btn-bg: #D32F2F;
    /* Rouge pour le bouton supprimer */
    --status-en-cours: #388E3C;
    /* Vert pour "En cours" */
    --status-termine: #D32F2F;
    /* Rouge vif pour "Terminé" */
    --status-pause: #FBC02D;
    /* Jaune/orange pour "En pause" */
    --toast-bg-success: #388E3C;
    --toast-bg-error: #D32F2F;
    --toast-bg-warning: #FBC02D;
    --toast-bg-info: #3F51B5;
    --toast-color: #FFFFFF;
    --input-bg: #FFFFFF;
    --input-border: #BDBDBD;
    --input-focus: #3F51B5;
    --card-shadow: rgba(0, 0, 0, 0.1);
    --card-hover-shadow: rgba(0, 0, 0, 0.2);
    --button-text-color: #FFFFFF;
    --button-font-weight: 500;
    --button-border-radius: 4px;
    /* Rayon des boutons réduit */
    --tag-bg: #BDBDBD;
    --tag-color: #212121;
    --tag-border: #BDBDBD;
    --tag-hover-bg: #9E9E9E;
    --minimal-card-bg: #FFFFFF;
    /* Fond des cartes en mode minimaliste */
    --select-arrow: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><path fill="%23757575" d="M6 9L1.5 4.5h9L6 9z"/></svg>') no-repeat right 10px center;
  }

  body.dark-mode {
    /* Mode sombre */
    --bg-color: #303030;
    --text-color: #ffffff;
    --text-secondary: #BDBDBD;
    --card-background: #424242;
    --accent-color: #7986CB;
    /* Bleu Indigo clair */
    --accent-hover: #5C6BC0;
    --header-bg: #424242;
    --header-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    --filter-bg: #ffffff;
    --modal-overlay: rgba(0, 0, 0, 0.7);
    --delete-btn-bg: #E57373;
    --status-en-cours: #81C784;
    --status-termine: #E57373;
    --status-pause: #FFEB3B;
    --toast-bg-success: #81C784;
    --toast-bg-error: #E57373;
    --toast-bg-warning: #FFEB3B;
    --toast-bg-info: #7986CB;
    --input-bg: #616161;
    --input-border: #BDBDBD;
    --input-focus: #7986CB;
    --card-shadow: rgba(255, 255, 255, 0.1);
    --card-hover-shadow: rgba(255, 255, 255, 0.2);
    --button-text-color: #FFFFFF;
    --button-font-weight: 500;
    --button-border-radius: 4px;
    --tag-bg: #757575;
    --tag-color: #FAFAFA;
    --tag-border: #BDBDBD;
    --tag-hover-bg: #9E9E9E;
    --minimal-card-bg: #424242;
    /* Fond des cartes en mode minimaliste sombre */
    --select-arrow: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><path fill="%23BDBDBD" d="M6 9L1.5 4.5h9L6 9z"/></svg>') no-repeat right 10px center;
  }

  a {
    text-decoration: none;
    color: inherit;
  }

  .hidden {
    display: none !important;
  }

  /****************************************************
   *                 ANIMATIONS ETC.                  *
   ****************************************************/
  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes slideDown {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes toastFadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes toastFadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }

    to {
      opacity: 0;
      transform: translateY(20px);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s;
  }

  .slide-down {
    animation: slideDown 0.5s;
  }

  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--toast-bg-info);
    color: var(--toast-color);
    padding: 0.6rem 1rem;
    /* Padding ajusté */
    border-radius: 4px;
    /* Rayon réduit */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    opacity: 0;
    transform: translateY(20px);
    animation: toastFadeIn 0.5s forwards;
    z-index: 2000;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 200px;
    /* Largeur minimale */
    max-width: 300px;
    /* Largeur maximale */
    font-family: 'Montserrat', sans-serif;
    transition: opacity 0.3s, transform 0.3s;
  }

  .toast.hide {
    animation: toastFadeOut 0.5s forwards;
  }

  .toast.success {
    background: var(--toast-bg-success);
  }

  .toast.error {
    background: var(--toast-bg-error);
  }

  .toast.warning {
    background: var(--toast-bg-warning);
  }

  .toast.info {
    background: var(--toast-bg-info);
  }

  /****************************************************
   *                    TOP NAV BAR                   *
   ****************************************************/
  .top-nav {
    background: var(--header-bg);
    color: var(--text-color);
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--header-shadow);
    transition: background 0.3s ease, color 0.3s ease;
    font-family: 'Montserrat', sans-serif;
    position: sticky;
    top: 0;
    z-index: 1000;
    flex-wrap: wrap;
  }

  /* Structure de la navbar */
  .nav-left,
  .nav-center,
  .nav-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .nav-left {
    flex: 0.5;
    min-width: 150px;
  }

  .nav-center {
    flex: 0.5;
    min-width: 250px;
    justify-content: left;
  }

  .nav-right {
    flex: 1;
    min-width: 150px;
    justify-content: flex-end;
  }

  /* Logo de la navbar */
  .top-nav .logo {
    font-weight: 700;
    font-size: 1rem;
    color: var(--accent-color);
    text-decoration: none;
    white-space: nowrap;
  }

  /* Menu Hamburger pour petits écrans */
  .hamburger {
    display: none;
    flex-direction: column;
    justify-content: space-between;
    width: 24px;
    height: 18px;
    cursor: pointer;
    z-index: 1100;
    /* Pour rester au-dessus */
  }

  .hamburger div {
    width: 100%;
    height: 3px;
    background-color: var(--text-color);
    border-radius: 2px;
    /* Ajout pour un style plus doux */
    transition: transform 0.3s ease, background-color 0.3s ease;
  }

  /* Navbar responsive */
  .nav-right.responsive {
    flex-direction: column;
    width: 100%;
    display: none;
  }

  .nav-right.responsive.active {
    display: flex;
    background: var(--header-bg);
    /* Couleur de fond cohérente */
    padding: 1rem 0;
  }

  /* Media Queries pour la responsivité */
  @media (max-width: 768px) {
    .hamburger {
      display: flex;
      margin-left: 1rem;
    }

    .nav-left,
    .nav-center,
    .nav-right {
      flex: none;
      width: 100%;
      justify-content: center;
    }

    .nav-right {
      display: none;
    }

    .nav-right.active {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  }


  /* Container pour les filtres et tri */
  .filters-sort-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    /* Réduction du gap */
    flex-wrap: wrap;
    /* Permet le wrap sur petits écrans */
    justify-content: center;
  }

  .filters-dropdown select,
  .sort-dropdown select {
    padding: 0.4rem 0.6rem;
    /* Padding réduit */
    border-radius: var(--button-border-radius);
    font-size: 0.8rem;
    /* Réduction de la taille */
    border: 1px solid var(--input-border);
    background: var(--filter-bg);
    color: rgb(157, 157, 157);
    cursor: pointer;
    transition: background 0.15s ease, color 0.15s ease;
    font-family: 'Roboto', sans-serif;
    appearance: none;
    /* Supprime l'apparence par défaut */
    background-image: var(--select-arrow);
    /* Ajoute une flèche personnalisée */
    background-repeat: no-repeat;
    background-position: right 0.6rem center;
    background-size: 12px;
    min-width: 120px;
    /* Largeur minimale */
  }

  .filters-dropdown select:hover,
  .filters-dropdown select:focus,
  .sort-dropdown select:hover,
  .sort-dropdown select:focus {
    background-color: var(--filter-bg);
    color: var(--text-color);
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px var(--input-focus);
  }

  /* Container pour la recherche */
  .search-container {
    position: relative;
    flex: 1;
    max-width: 200px;
    /* Réduction de la largeur */
    margin-left: 0.5rem;
  }

  .search-container input {
    width: 100%;
    padding: 0.4rem 0.8rem;
    /* Padding réduit */
    border: 1px solid var(--input-border);
    border-radius: var(--button-border-radius);
    font-size: 0.8rem;
    /* Réduction de la taille */
    background: rgb(255, 255, 255);
    color: var(--text-color);
    transition: border 0.3s;
    font-family: 'Roboto', sans-serif;
  }

  .search-container input:focus {
    border-color: var(--input-focus);
    outline: none;
    box-shadow: 0 0 0 2px var(--input-focus);
  }

  /* Suggestions dropdown */
  #suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card-background);
    border: 1px solid var(--input-border);
    border-top: none;
    max-height: 150px;
    /* Réduction de la hauteur */
    overflow-y: auto;
    z-index: 1001;
    list-style: none;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    font-size: 0.8rem;
    /* Réduction de la taille */
  }

  #suggestions li {
    padding: 0.4rem 0.6rem;
    /* Padding réduit */
    cursor: pointer;
    font-family: 'Roboto', sans-serif;
    transition: background 0.2s;
  }

  #suggestions li:hover,
  #suggestions li.active {
    background-color: var(--filter-bg);
  }

  .top-nav .nav-section {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    /* Réduction du gap */
    white-space: nowrap;
    /* Empêche le wrap */
    flex-wrap: wrap;
  }

  .top-nav .action-btn {
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    border-radius: var(--button-border-radius);
    font-size: 0.8rem;
    /* Réduction de la taille */
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.15s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background-color: var(--accent-color);
    color: var(--button-text-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    text-decoration: none;
    white-space: nowrap;
  }

  .top-nav .action-btn:hover,
  .top-nav .action-btn:focus {
    background-color: var(--accent-hover);
    transform: translateY(-1px);
    outline: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  .top-nav .icon-btn {
    padding: 0.3rem;
    border-radius: var(--button-border-radius);
    color: var(--text-secondary);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 1rem;
    /* Taille augmentée pour meilleure accessibilité */
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }

  .top-nav .icon-btn:hover,
  .top-nav .icon-btn:focus {
    background-color: var(--filter-bg);
    color: var(--text-color);
    outline: none;
  }

  /* Bouton Vue Minimaliste */
  .top-nav .toggle-minimal-view-btn {
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    border-radius: var(--button-border-radius);
    color: var(--text-secondary);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 0.8rem;
    /* Réduction de la taille */
    display: flex;
    align-items: center;
    gap: 0.3rem;
    white-space: nowrap;
  }

  .top-nav .toggle-minimal-view-btn:hover,
  .top-nav .toggle-minimal-view-btn:focus {
    background-color: var(--filter-bg);
    color: var(--text-color);
    outline: none;
  }

  /* Import/Export intégré */
  .import-export-container {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    /* Réduction du gap */
    margin-left: 0.5rem;
    white-space: nowrap;
  }

  .import-export-container label {
    background-color: var(--accent-color);
    color: var(--button-text-color);
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    border-radius: var(--button-border-radius);
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    font-size: 0.8rem;
    /* Réduction de la taille */
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    white-space: nowrap;
  }

  .import-export-container label:hover,
  .import-export-container label:focus {
    background-color: var(--accent-hover);
    transform: translateY(-1px);
    outline: none;
  }

  .import-export-container input[type="file"] {
    display: none;
  }

  #export-btn {
    background-color: var(--accent-color);
    color: var(--button-text-color);
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    border-radius: var(--button-border-radius);
    border: none;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    font-size: 0.8rem;
    /* Réduction de la taille */
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    white-space: nowrap;
  }

  #export-btn:hover,
  #export-btn:focus {
    background-color: var(--accent-hover);
    transform: translateY(-1px);
    outline: none;
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {

    .top-nav .filters-dropdown select,
    .top-nav .sort-dropdown select {
      width: 100px;
      /* Réduction de la largeur */
    }

    .nav-left {
      flex: 1;
      min-width: 100px;
    }

    .nav-center {
      flex: 2;
      min-width: 150px;
    }

    .nav-right {
      flex: 1;
      min-width: 100px;
      justify-content: center;
    }

    .top-nav .nav-section {
      gap: 0.2rem;
      /* Réduction du gap */
    }
  }

  @media (max-width: 768px) {
    .top-nav {
      flex-direction: column;
      align-items: flex-start;
    }

    .nav-center {
      order: 3;
      width: 100%;
      justify-content: flex-start;
      margin-top: 0.5rem;
    }

    .nav-right {
      order: 2;
      width: 100%;
      justify-content: space-between;
      margin-top: 0.5rem;
    }

    /* suggestion style */
    .suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      /* Initialement caché */
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .suggestions li {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
    }

    .suggestions li:hover,
    .suggestions li.active {
      background-color: #f0f0f0;
    }

    .suggestions img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      margin-right: 8px;
      border-radius: 4px;
    }

    .search-container {
      max-width: 100%;
      margin-left: 0;
      margin-top: 0.5rem;
    }

    .filters-sort-container {
      justify-content: flex-start;
      width: 100%;
    }

    .hamburger {
      display: flex;
    }

    .nav-right {
      display: none;
      flex-direction: column;
      width: 100%;
    }

    .nav-right.active {
      display: flex;
    }
  }

  @media (max-width: 480px) {
    .top-nav .logo {
      font-size: 0.9rem;
      /* Taille réduite */
    }

    .filters-dropdown select,
    .sort-dropdown select {
      min-width: 80px;
      /* Réduction de la largeur minimale */
    }

    .search-container input {
      font-size: 0.7rem;
      /* Réduction de la taille */
    }

    .top-nav .action-btn,
    .top-nav .icon-btn,
    .toggle-minimal-view-btn,
    .import-export-container label,
    #export-btn,
    #btn-show-stats,
    #btn-open-modal {
      font-size: 0.7rem;
      /* Réduction de la taille */
      padding: 0.2rem 0.4rem;
      /* Padding réduit */
    }

    .filters-sort-container {
      flex-direction: column;
      align-items: flex-start;
    }

    .filters-dropdown select,
    .sort-dropdown select {
      width: 100%;
    }

    .search-container {
      margin-top: 0.5rem;
    }

    .toast {
      bottom: 10px;
      right: 10px;
      min-width: 150px;
      max-width: 250px;
      padding: 0.4rem 0.8rem;
    }

    .flip-card {
      height: auto;
      /* Ajustement automatique de la hauteur */
    }

    .flip-card-inner {
      height: 100%;
    }

    .flip-card-front,
    .flip-card-back {
      padding: 0.5rem;
      /* Padding réduit */
    }

    .cover-image {
      height: 120px;
      /* Réduction de la hauteur */
    }

    .progress-bar-container {
      height: 6px;
      /* Hauteur réduite */
    }

    .chap-btn {
      width: 20px;
      /* Taille réduite */
      height: 20px;
    }

    .chap-label {
      font-size: 0.7rem;
      /* Taille réduite */
    }
  }

  /****************************************************
   *                 WELCOME SCREEN                   *
   ****************************************************/
  .welcome-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    /* Opacité augmentée */
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.6s;
  }

  .welcome-content {
    background: var(--card-background);
    padding: 2rem;
    /* Padding réduit */
    border-radius: 8px;
    /* Rayon réduit */
    max-width: 500px;
    /* Largeur réduite */
    width: 90%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.5s;
    color: var(--text-color);
    font-family: 'Montserrat', sans-serif;
  }

  .welcome-content h1 {
    font-size: 1.8rem;
    /* Taille réduite */
    margin-bottom: 1rem;
    color: var(--accent-color);
    font-weight: 700;
  }

  .welcome-content p {
    margin-bottom: 1.5rem;
    line-height: 1.6;
    font-size: 0.95rem;
    /* Taille réduite */
  }

  .welcome-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    /* Permet le wrap sur petits écrans */
  }

  .welcome-actions label {
    font-size: 0.9rem;
    /* Taille réduite */
    color: var(--text-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    user-select: none;
    font-weight: 500;
  }

  .welcome-actions input[type="checkbox"] {
    width: 16px;
    /* Taille réduite */
    height: 16px;
    cursor: pointer;
    accent-color: var(--accent-color);
  }

  .welcome-actions button {
    background: var(--accent-color);
    color: var(--button-text-color);
    border: none;
    border-radius: var(--button-border-radius);
    padding: 0.5rem 1.5rem;
    /* Padding réduit */
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    font-size: 0.9rem;
    /* Taille réduite */
    font-weight: 500;
    /* Taille réduite */
    font-family: 'Montserrat', sans-serif;
  }

  .welcome-actions button:hover,
  .welcome-actions button:focus {
    background: var(--accent-hover);
    transform: translateY(-1px);
    outline: none;
  }

  /****************************************************
   *                LIST SECTION                       *
   ****************************************************/
  #list-section {
    flex: 1;
    padding: 1.5rem;
    /* Padding réduit */
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    /* Taille minimale ajustée */
    gap: 1.5rem;
    /* Espacement réduit */
    background: var(--bg-color);
    transition: all 0.3s;
    overflow-y: auto;
  }

  #list-section.minimalist-view {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }

  .empty-message {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--text-secondary);
    margin-top: 2rem;
    font-style: italic;
    font-size: 1rem;
    /* Taille réduite */
  }

  /****************************************************
   *                FLIP CARDS (DRAGGABLE)            *
   ****************************************************/
  .flip-card {
    width: 100%;
    height: 450px;
    /* Hauteur ajustée pour plus de contenu */
    perspective: 1000px;
    position: relative;
    border-radius: 8px;
    /* Rayon réduit */
    margin: 0 auto;
    cursor: grab;
    transition: transform 0.3s, box-shadow 0.4s;
    background: var(--card-background);
    box-shadow: 0 4px 10px var(--card-shadow);
    /* Ombre réduite */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flip-card.minimalist {
    height: 320px;
    /* Hauteur réduite en mode minimaliste */
    background: var(--minimal-card-bg);
  }

  .flip-card.minimalist .hidden-in-minimalist {
    display: none;
    /* Cache complètement l'élément */
  }

  .flip-card:hover {
    transform: translateY(-5px);
    /* Déplacement réduit */
    box-shadow: 0 8px 20px var(--card-hover-shadow);
    /* Ombre réduite */
  }

  .flip-card:active {
    cursor: grabbing;
    transform: scale(1.02);
  }

  .flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.8s ease;
    transform-style: preserve-3d;
    border-radius: 8px;
  }

  .flip-card-inner.flipped {
    transform: rotateY(180deg);
  }

  .flip-card-front,
  .flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    padding: 0.8rem;
    /* Padding réduit */
    background: var(--card-background);
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    pointer-events: none;
    /* Empêche les événements sur la face non active */
  }

  .flip-card-front,
  .flip-card-back {
    pointer-events: auto;
    /* Permet les interactions sur la face active */
  }

  .flip-card-front {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    /* Équilibre les éléments */
    background: linear-gradient(135deg, rgba(245, 245, 245, 0.95) 60%, rgba(245, 245, 245, 0.85) 100%);
    height: 100%;
    /* Assure que la face avant prend toute la hauteur de la carte */
  }

  body.dark-mode .flip-card-front {
    background: linear-gradient(135deg, rgba(66, 66, 66, 0.95) 60%, rgba(66, 66, 66, 0.85) 100%);

  }

  .flip-card-back {
    transform: rotateY(180deg);
    background: linear-gradient(135deg, rgba(66, 66, 66, 0.95) 60%, rgba(66, 66, 66, 0.85) 100%);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    padding: 1rem;
    /* Padding réduit */
    color: #FAFAFA;
  }

  /* Bouton Flip (face front/back) */
  .flip-btn-front,
  .flip-btn-back {
    position: absolute;
    top: 0.6rem;
    right: 0.6rem;
    background: var(--accent-color);
    border: none;
    color: #FFFFFF;
    border-radius: 50%;
    cursor: pointer;
    padding: 0.3rem;
    font-size: 0.8rem;
    /* Taille réduite */
    transition: background 0.3s, color 0.3s, transform 0.2s;
    width: 25px;
    /* Taille réduite */
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
  }

  .flip-btn-front:hover,
  .flip-btn-back:hover,
  .flip-btn-front:focus,
  .flip-btn-back:focus {
    background: var(--accent-hover);
    color: #fff;
    transform: rotate(90deg);
    outline: none;
  }

  /* Face FRONT */
  .front-top {
    margin-bottom: 0.5rem;
    /* Marge réduite */
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    /* Gap réduit */
    flex: 1;
  }

  .card-title {
    font-size: 1rem;
    /* Taille réduite */
    font-weight: 700;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    color: var(--text-color);
    font-family: 'Montserrat', sans-serif;
  }

  .subinfo-front {
    font-size: 0.7rem;
    /* Taille réduite */
    color: var(--text-secondary);
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    font-family: 'Roboto', sans-serif;
  }

  .cover-image {
    width: 100%;
    height: 150px;
    /* Hauteur ajustée */
    object-fit: cover;
    border-radius: 4px;
    /* Rayon réduit */
    margin-bottom: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
  }

  .cover-image:hover {
    transform: scale(1.03);
    cursor: pointer;
  }

  .fav-container {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    /* Gap réduit */
    margin-top: auto;
    /* Pousse vers le bas */
  }

  .fav-container input[type="checkbox"] {
    width: 14px;
    /* Taille réduite */
    height: 14px;
    cursor: pointer;
    accent-color: var(--accent-color);
    pointer-events: auto;
  }

  .fav-container label {
    font-weight: 500;
    cursor: pointer;
    color: var(--text-color);
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    /* Taille réduite */
    display: flex;
    align-items: center;
    gap: 0.2rem;
    transition: transform 0.2s;
  }

  .fav-container label:hover {
    transform: scale(1.05);
  }

  .chap-stepper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.3rem;
    /* Gap réduit */
    margin-top: 0.5rem;
    /* Marge réduite */
  }

  .chap-btn {
    background: var(--accent-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 0.2rem;
    font-size: 0.8rem;
    /* Taille réduite */
    color: var(--button-text-color);
    font-weight: var(--button-font-weight);
    transition: background 0.3s, transform 0.2s;
    width: 25px;
    /* Taille réduite */
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .chap-btn:hover,
  .chap-btn:focus {
    background: var(--accent-hover);
    transform: translateY(-1px);
    outline: none;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }

  .chap-label {
    font-size: 0.8rem;
    /* Taille réduite */
    font-weight: 600;
    color: var(--text-color);
    text-align: center;
    flex: 1;
    font-family: 'Montserrat', sans-serif;
  }

  /* Statut coloré */
  .status-label {
    font-size: 0.7rem;
    /* Taille réduite */
    border-radius: 4px;
    padding: 0.2rem 0.4rem;
    /* Padding réduit */
    color: #fff;
    margin-bottom: 1px;
    display: inline-block;
    font-weight: 600;
    align-self: flex-start;
    text-transform: capitalize;
    font-family: 'Montserrat', sans-serif;
  }

  .status-label.en-cours {
    background: var(--status-en-cours);
  }

  .status-label.termine {
    background: var(--status-termine);
  }

  .status-label.pause {
    background: var(--status-pause);
  }

  /* Note affichée sur le devant */
  .note-label {
    font-size: 0.7rem;
    /* Taille réduite */
    font-weight: 600;
    color: var(--status-termine);
    margin-top: 0.2rem;
    font-family: 'Montserrat', sans-serif;
  }

  /* Face BACK */
  .back-title {
    font-size: 1rem;
    /* Taille réduite */
    font-weight: 700;
    margin-bottom: 0.5rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    color: #FAFAFA;
    font-family: 'Montserrat', sans-serif;
  }

  .back-info {
    flex: 1;
    font-size: 0.8rem;
    /* Taille réduite */
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    /* Gap réduit */
    line-height: 1.4;
    overflow-y: auto;
    color: #BDBDBD;
    font-family: 'Roboto', sans-serif;
  }

  .stars {
    color: #FFEB3B;
    margin-top: 0.2rem;
    font-size: 0.8rem;
    /* Taille réduite */
  }

  .link-section {
    font-size: 0.75rem;
    /* Taille réduite */
    color: var(--accent-color);
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    font-family: 'Roboto', sans-serif;
  }

  .link-section a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
    transition: text-decoration 0.3s;
  }

  .link-section a:hover,
  .link-section a:focus {
    text-decoration: underline;
    outline: none;
  }

  .notes-section {
    font-size: 0.7rem;
    /* Taille réduite */
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 0.2rem;
    font-family: 'Roboto', sans-serif;
  }

  .actions {
    display: flex;
    gap: 0.5rem;
    /* Gap réduit */
    margin-top: 1rem;
    /* Marge réduite */
    justify-content: center;
  }

  .actions button {
    border: none;
    border-radius: var(--button-border-radius);
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    cursor: pointer;
    font-size: 0.75rem;
    /* Taille réduite */
    transition: background 0.3s, transform 0.2s;
    color: var(--button-text-color);
    font-weight: var(--button-font-weight);
    font-family: 'Montserrat', sans-serif;
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
  }

  .edit-btn {
    background: #388E3C;
    /* Vert pour l'édition */
  }

  .edit-btn:hover,
  .edit-btn:focus {
    background: #2E7D32;
    transform: translateY(-1px);
    outline: none;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }

  .delete-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #fff;
    background: linear-gradient(135deg, #ff4b4b 0%, #ff6b6b 100%);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(255, 75, 75, 0.25);
    position: relative;
    overflow: hidden;
  }

  .delete-btn::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #ff3b3b 0%, #ff5b5b 100%);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .delete-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 75, 75, 0.35);
  }

  .delete-btn:hover::before {
    opacity: 1;
  }

  .delete-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(255, 75, 75, 0.2);
  }

  /* Animation pour l'icône */
  .delete-btn span {
    transition: transform 0.2s ease;
  }

  .delete-btn:hover span {
    transform: scale(1.1);
  }

  /* Style pour l'état disabled */
  .delete-btn:disabled {
    background: linear-gradient(135deg, #cccccc 0%, #dddddd 100%);
    cursor: not-allowed;
    box-shadow: none;
  }

  .delete-btn:disabled::before {
    display: none;
  }

  /* État de focus pour l'accessibilité */
  .delete-btn:focus-visible {
    outline: 2px solid #ff4b4b;
    outline-offset: 2px;
  }

  /* Version sombre */
  @media (prefers-color-scheme: dark) {
    .delete-btn {
      background: linear-gradient(135deg, #ff3b3b 0%, #ff5b5b 100%);
    }

    .delete-btn::before {
      background: linear-gradient(135deg, #ff2b2b 0%, #ff4b4b 100%);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .delete-btn {
      padding: 0.625rem 1rem;
      font-size: 0.8125rem;
    }
  }

  /* Progressbar */
  .progress-bar-container {
    width: 100%;
    background: var(--filter-bg);
    height: 8px;
    /* Hauteur réduite */
    border-radius: 4px;
    /* Rayon réduit */
    overflow: hidden;
    margin-bottom: 0.8rem;
    /* Marge réduite */
    margin-top: 0.3rem;
  }

  .progress-bar {
    background: var(--accent-color);
    height: 100%;
    width: 0%;
    transition: width 0.3s;
  }

  /* Ajout d'une section de notes sur le devant */
  .front-notes {
    font-size: 0.7rem;
    /* Taille réduite */
    color: var(--text-secondary);
    margin-top: 0.3rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-box-orient: vertical;
  }

  /****************************************************
   *                MODALE ITEM (AJOUT / EDIT)       *
   ****************************************************/
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--modal-overlay);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.5s;
    overflow: auto;
    padding: 1rem;
    /* Ajout de padding pour petits écrans */
  }

  .modal-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
  }

  .modal-content {
    position: relative;
    background: var(--card-background);
    border-radius: 8px;
    /* Rayon réduit */
    padding: 1rem;
    /* Padding réduit */
    max-width: 600px;
    /* Largeur réduite */
    width: 100%;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    /* Gap réduit */
    color: var(--text-color);
    animation: slideDown 0.5s;
    max-height: 90vh;
    overflow-y: auto;
    font-family: 'Montserrat', sans-serif;
  }

  .close-modal {
    position: absolute;
    top: 0.6rem;
    right: 0.6rem;
    font-size: 1.2rem;
    /* Taille réduite */
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.3s;
  }

  .close-modal:hover,
  .close-modal:focus {
    color: var(--text-color);
    outline: none;
  }

  .modal-content h2 {
    font-size: 1.3rem;
    /* Taille réduite */
    margin-bottom: 0.8rem;
    color: var(--accent-color);
    text-align: center;
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
  }

  /* Nouveau layout pour le formulaire "Ajouter/Modifier un élément" */
  #item-form {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    /* Grille flexible sur 12 colonnes */
    gap: 1.5rem;
    /* Espacement généreux entre les éléments */
    padding: 2rem;
    /* Padding interne pour respirer */
    background-color: var(--form-bg);
    border-radius: 12px;
    /* Contours arrondis pour modernité */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    /* Ombre subtile */
    font-family: 'Roboto', sans-serif;
  }

  /* Champs occupant une pleine largeur */
  .form-group-full {
    grid-column: span 12;
    /* Occupe toute la largeur */



  }

  /* Gestion des colonnes pour différents éléments */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    /* Espacement interne */
    grid-column: span 6;
    /* Par défaut, chaque champ occupe 50% */
  }

  .form-group-inline {
    display: flex;
    align-items: center;
    /* Alignement vertical des éléments */
    gap: 1rem;
    /* Espacement horizontal entre les éléments */
    grid-column: span 12;
    /* Étale sur toute la largeur */
  }

  .form-group-inline label {
    font-size: 1rem;
    font-weight: 500;
    color: var(--label-color);
    font-family: 'Montserrat', sans-serif;
    white-space: nowrap;
    /* Empêche le saut de ligne pour le label */
  }

  .form-group-inline input[type="checkbox"] {
    transform: scale(1.2);
    /* Augmente la taille de la case à cocher */
    cursor: pointer;
    /* Ajoute un pointeur pour indiquer la cliquabilité */
  }

  /* Labels */
  .form-group label {
    font-size: 1rem;
    /* Taille lisible et moderne */
    font-weight: 500;
    color: var(--label-color);
    font-family: 'Montserrat', sans-serif;
  }

  /* Champs de saisie */
  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 0.8rem 1rem;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    /* Forme plus douce */
    font-size: 1rem;
    background-color: var(--input-bg);
    color: var(--text-color);
    transition: all 0.3s ease;
    font-family: 'Roboto', sans-serif;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--input-focus);
    box-shadow: 0 0 6px rgba(0, 123, 255, 0.5);
    /* Glow subtil */
    outline: none;
  }

  /* Alignement et espacement pour les labels optionnels */
  .form-group label::after {
    font-size: 0.9rem;
    font-weight: 400;
    color: var(--text-secondary-color);
    margin-left: 0.2rem;
    font-style: italic;
  }


  /* Champs de dates */
  .date-group {
    display: flex;
    gap: 1rem;
    /* Espacement cohérent entre les champs */
    grid-column: span 12;
    align-items: flex-start;
    /* Alignement parfait des dates */
  }

  .date-group .form-group {
    flex: 1;
    /* Permet un partage équitable de l'espace */
  }

  /* Notes personnelles */
  #item-notes {
    grid-column: span 12;
    /* Étale les notes sur toute la largeur */
    resize: vertical;
    min-height: 100px;
    /* Taille par défaut augmentée */
    max-height: 200px;
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    padding: 0.8rem;
    font-size: 1rem;
    color: var(--text-color);
    transition: all 0.3s ease;
  }

  #item-notes:focus {
    border-color: var(--input-focus);
  }

  /* Boutons d'action */
  .form-actions {
    grid-column: span 12;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
    /* Espacement suffisant au-dessus */
  }

  #save-btn,
  #cancel-btn {
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #save-btn {
    background-color: var(--accent-color);
    color: var(--button-text-color);
    border: none;
  }

  #save-btn:hover {
    background-color: var(--accent-hover);
    transform: translateY(-2px);
  }

  #cancel-btn {
    background-color: #6C757D;
    color: #fff;
    border: none;
  }

  #cancel-btn:hover {
    background-color: #5A6268;
    transform: translateY(-2px);
  }

  /* Bouton "Trouver l'image" */
  #find-cover-btn {
    grid-column: span 12;
    align-self: flex-start;
    padding: 0.8rem 1.2rem;
    background-color: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  #find-cover-btn:hover {
    background-color: var(--accent-hover);
    transform: translateY(-2px);
  }

  /* Aperçu de l'image */
  .cover-preview {
    margin-top: 1rem;
    max-width: 100%;
    max-height: 180px;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    object-fit: contain;
    display: none;
  }

  /* Adaptations mobiles */
  @media (max-width: 768px) {
    #item-form {
      grid-template-columns: repeat(6, 1fr);
    }

    .form-group {
      grid-column: span 6;
    }

    .form-actions {
      flex-direction: column;
      align-items: stretch;
    }
  }


  /****************************************************
   *                MODALE CATEGORIES                   *
   ****************************************************/
  .modal-cat {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--modal-overlay);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1500;
    animation: fadeIn 0.5s;
    overflow: auto;
    padding: 1rem;
    /* Ajout de padding pour petits écrans */
  }

  .modal-cat-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
  }

  .modal-cat-content {
    position: relative;
    background: var(--card-background);
    border-radius: 8px;
    /* Rayon réduit */
    padding: 1rem;
    /* Padding réduit */
    max-width: 500px;
    /* Largeur réduite */
    width: 100%;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    /* Gap réduit */
    color: var(--text-color);
    animation: slideDown 0.5s;
    max-height: 90vh;
    overflow-y: auto;
    font-family: 'Montserrat', sans-serif;
  }

  #close-cat-modal {
    position: absolute;
    top: 0.6rem;
    right: 0.6rem;
    font-size: 1.2rem;
    /* Taille réduite */
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.3s;
  }

  #close-cat-modal:hover,
  #close-cat-modal:focus {
    color: var(--text-color);
    outline: none;
  }

  #cat-list {
    list-style: none;
    padding-left: 0;
    margin-bottom: 0.8rem;
    /* Marge réduite */
    max-height: 150px;
    /* Hauteur réduite */
    overflow-y: auto;
    font-size: 0.8rem;
    /* Taille réduite */
  }

  #cat-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.4rem;
    /* Marge réduite */
    border: 1px solid var(--input-border);
    border-radius: 4px;
    /* Rayon réduit */
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    background: var(--input-bg);
    color: var(--text-color);
    transition: background 0.3s;
    font-family: 'Roboto', sans-serif;
  }

  #cat-list li:hover {
    background: var(--filter-bg);
  }

  #cat-list li span {
    font-size: 0.9rem;
    /* Taille réduite */
    font-weight: 500;
  }

  .del-cat-btn {
    background: var(--delete-btn-bg);
    border: none;
    color: #fff;
    border-radius: 4px;
    /* Rayon réduit */
    cursor: pointer;
    padding: 0.2rem 0.4rem;
    /* Padding réduit */
    font-size: 0.7rem;
    /* Taille réduite */
    transition: background 0.3s, transform 0.2s;
    font-family: 'Montserrat', sans-serif;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .del-cat-btn:hover,
  .del-cat-btn:focus {
    background: #D32F2F;
    transform: translateY(-1px);
    outline: none;
  }

  .cat-actions {
    display: flex;
    gap: 0.5rem;
    /* Gap réduit */
    margin-top: 0.8rem;
    /* Marge réduite */
  }

  .cat-actions input[type="text"] {
    flex: 1;
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    border: 1px solid var(--input-border);
    border-radius: 4px;
    /* Rayon réduit */
    transition: border 0.3s;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 0.8rem;
    /* Taille réduite */
    font-family: 'Roboto', sans-serif;
  }

  .cat-actions input[type="text"]:focus {
    border-color: var(--input-focus);
    outline: none;
  }

  .add-cat-btn {
    background: var(--accent-color);
    color: var(--button-text-color);
    border: none;
    border-radius: var(--button-border-radius);
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    font-size: 0.8rem;
    /* Taille réduite */
    font-weight: var(--button-font-weight);
    font-family: 'Montserrat', sans-serif;
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    white-space: nowrap;
  }

  .add-cat-btn:hover,
  .add-cat-btn:focus {
    background: var(--accent-hover);
    transform: translateY(-1px);
    outline: none;
  }

  /* Modal Statistics */
  .modal-stats {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
    display: grid;
    place-items: center;
    z-index: 1600;
    opacity: 0;
    animation: modalFadeIn 0.3s ease forwards;
    padding: clamp(1rem, 5vw, 2rem);
  }

  .modal-stats-overlay {
    position: absolute;
    inset: 0;
  }

  .modal-stats-content {
    position: relative;
    background: var(--card-background, #fff);
    border-radius: 16px;
    padding: clamp(1.5rem, 3vw, 2rem);
    width: min(500px, 100%);
    box-shadow:
      0 10px 30px -5px rgba(0, 0, 0, 0.2),
      0 2px 8px -3px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    color: var(--text-color, #333);
    opacity: 0;
    transform: translateY(20px);
    animation: modalSlideUp 0.4s ease 0.1s forwards;
    max-height: 85vh;
    overflow-y: auto;
    scrollbar-width: thin;
  }

  .modal-stats-content::-webkit-scrollbar {
    width: 6px;
  }

  .modal-stats-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-stats-content::-webkit-scrollbar-thumb {
    background-color: var(--accent-color, #666);
    border-radius: 3px;
  }

  .modal-stats-content canvas {
    width: 100%;
    height: auto;
    border-radius: 8px;
    transition: transform 0.2s ease;
  }

  .modal-stats-content canvas:hover {
    transform: scale(1.02);
  }

  #close-stats-modal {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 32px;
    height: 32px;
    display: grid;
    place-items: center;
    border-radius: 50%;
    border: none;
    background: var(--background-secondary, #f5f5f5);
    color: var(--text-secondary, #666);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #close-stats-modal:hover {
    background: var(--background-hover, #eee);
    color: var(--text-color, #333);
    transform: rotate(90deg);
  }

  .stats-title {
    font-size: clamp(1.5rem, 3vw, 1.75rem);
    line-height: 1.3;
    font-weight: 700;
    text-align: center;
    color: var(--accent-color, #333);
    letter-spacing: -0.02em;
  }

  .stats-summary {
    text-align: center;
    font-size: clamp(0.9rem, 2vw, 1rem);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    color: var(--text-secondary, #666);
  }

  .stats-chart-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 0.5rem;
  }

  .stats-subtitle {
    font-size: clamp(1.1rem, 2.5vw, 1.25rem);
    font-weight: 600;
    color: var(--text-color, #333);
    text-align: center;
    margin-bottom: 0.5rem;
  }

  .stats-row {
    display: grid;
    grid-template-columns: 100px 1fr 50px;
    gap: 1rem;
    align-items: center;
    padding: 0.5rem 0;
  }

  .stats-label {
    text-align: right;
    font-size: 0.9rem;
    color: var(--text-secondary, #666);
  }

  .stats-bar {
    position: relative;
    height: 8px;
    background: var(--background-secondary, #f0f0f0);
    border-radius: 4px;
    overflow: hidden;
  }

  .stats-bar::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--accent-color, #666);
    border-radius: inherit;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stats-count {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-color, #333);
    text-align: right;
  }

  @keyframes modalFadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes modalSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .stats-row {
      grid-template-columns: 80px 1fr 40px;
      gap: 0.75rem;
    }

    .stats-label,
    .stats-count {
      font-size: 0.8rem;
    }

    .stats-bar {
      height: 6px;
    }
  }


  /****************************************************
   *              IMPORT / EXPORT DES DONNÉES         *
   ****************************************************/
  /* Styles déjà inclus dans la section des contrôles */

  /****************************************************
   *              BOUTON Lien Hypertexte               *
   ****************************************************/
  /* Styles pour le bouton de lien sur la face avant des cartes */
  .link-button {
    margin-top: auto;
    /* Pousse le bouton vers le bas de la carte */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.3rem 0.6rem;
    /* Padding réduit */
    background: var(--accent-color);
    color: var(--button-text-color);
    border: none;
    border-radius: var(--button-border-radius);
    text-align: center;
    font-size: 0.8rem;
    /* Taille réduite */
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    text-decoration: none;
    /* Enlever le soulignement */
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    font-family: 'Montserrat', sans-serif;
    font-weight: var(--button-font-weight);
    gap: 0.2rem;
    white-space: nowrap;
  }

  .link-button:hover,
  .link-button:focus {
    background: var(--accent-hover);
    transform: translateY(-1px);
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
    outline: none;
  }

  /****************************************************
   *                ACCESSIBILITY                      *
   ****************************************************/
  /* Focus outline pour les éléments interactifs */
  button:focus,
  .filter-btn:focus,
  .sort-dropdown select:focus,
  .toggle-theme-btn:focus,
  .chap-btn:focus,
  .flip-btn-front:focus,
  .flip-btn-back:focus,
  .edit-btn:focus,
  .delete-btn:focus,
  .add-cat-btn:focus,
  #save-btn:focus,
  #cancel-btn:focus,
  .import-export-container label:focus,
  #btn-open-modal:focus,
  #btn-manage-cats:focus,
  #btn-show-stats:focus,
  .toggle-minimal-view-btn:focus,
  .search-container input:focus,
  #cat-input:focus,
  .add-cat-btn:focus {
    outline: 2px solid var(--input-focus);
    /* Épaisseur réduite */
    outline-offset: 2px;
  }

  .autocomplete {
    position: absolute;
    /* Place la liste en position absolue */
    top: 100%;
    /* Place en bas de l'élément parent (l'input) */
    left: 0;
    /* Aligne la liste avec le bord gauche de l'input */
    width: 100%;
    /* Correspond à la largeur de l'input */
    background: white;
    border: 1px solid #ccc;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    /* Assure que la liste apparaît au-dessus d'autres éléments */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none;
    /* Masque la liste par défaut */
  }

  .autocomplete-item {
    display: flex;
    align-items: center;
    padding: 8px;
    gap: 0.5rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .autocomplete-item img {
    height: 40px;
    width: 40px;
    object-fit: cover;
    border-radius: 4px;
  }

  .autocomplete-item:hover {
    background: #f0f0f0;
  }
</style>

</head>

<body>

  <!-- NAV -->
  <nav class="top-nav" role="navigation" aria-label="Navigation principale">
    <div class="nav-left">
      <a href="#" class="logo">MyMiniMAL++</a>
      <!-- Barre de recherche avec suggestions -->
      <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Rechercher..."
          aria-label="Rechercher des éléments" aria-expanded="false" autocomplete="off" />
        <ul id="suggestions" class="suggestions" role="listbox" aria-label="Suggestions de recherche"></ul>
      </div>
      <!-- Menu Hamburger -->
      <div class="hamburger" id="hamburger" aria-label="Menu de navigation" tabindex="0">
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <div class="nav-center">
      <div class="filters-sort-container">
        <div class="filters-dropdown">
          <select id="filter-select" aria-label="Filtrer par catégorie">
            <option value="all">Tous</option>
            <!-- Dynamically added options via JavaScript -->
          </select>
        </div>

        <div class="sort-dropdown">
          <select id="sort-select" aria-label="Trier les éléments">
            <option value="default">Tri par défaut</option>
            <option value="title-asc">Titre (A-Z)</option>
            <option value="score-desc">Note (desc)</option>
            <option value="fav-first">Favoris en premier</option>
            <option value="progress-desc">Progression (desc)</option>
            <option value="recently-updated">Dernièrement mis à jour</option>
          </select>
        </div>
      </div>
    </div>

    <div class="nav-right">
      <div class="nav-section">
        <button class="icon-btn" id="btn-manage-cats" title="Gérer les catégories">≡</button>

        <button class="icon-btn" id="toggle-theme-btn" title="Activer/Désactiver le Dark Mode">🌙</button>
        <!-- Bouton Vue Minimaliste -->
        <button class="toggle-minimal-view-btn" id="toggle-minimal-view-btn" aria-label="Basculer en vue minimaliste">
          🗂️ Minimaliste
        </button>
        <button class="action-btn primary-btn" id="btn-open-modal" aria-label="Ajouter un élément">+ Ajouter</button>
        <button class="action-btn secondary-btn" id="btn-show-stats" aria-label="Afficher les statistiques">📊
          Stats</button>
        <!-- Import/Export intégré -->
        <div class="import-export-container">
          <button id="export-btn" aria-label="Exporter les données en JSON">📤 Exporter</button>
          <label for="import-file" class="action-btn secondary-btn"
            aria-label="Importer les données depuis un fichier JSON">📥 Importer</label>
          <input type="file" id="import-file" accept=".json" aria-hidden="true" />
        </div>
        <a href="login.html" class="icon-btn" aria-label="Se connecter">🔒 Login</a>

      </div>
    </div>


  </nav>

  <!-- ÉCRAN DE BIENVENUE -->
  <div id="welcome-screen" class="welcome-screen hidden" aria-modal="true" role="dialog" aria-labelledby="welcome-title"
    tabindex="-1">
    <div class="welcome-content slide-down">
      <h1 id="welcome-title">Bienvenue sur MyMiniMAL++</h1>
      <p>
        Organisez vos œuvres avec des outils intuitifs : cartes « flip », glisser-déposer,<br />
        gestion des chapitres (+/-1), personnalisation de la couverture, favoris, notes,<br />
        tri avancé, statistiques détaillées, mode sombre, export/import au format JSON, et bien plus encore !<br />
        <em>Dernières nouveautés : gestion des dates, tags personnalisés et tri par mise à jour !</em>
      </p>
      <div class="welcome-actions">
        <label for="dont-show-again">
          <input type="checkbox" id="dont-show-again" />
          Ne plus afficher
        </label>
        <button id="btn-close-welcome">Commencer</button>
      </div>
    </div>
  </div>
  <!-- /WELCOME SCREEN -->

  <!-- SECTION LISTE DRAG & DROP -->
  <main id="list-section"></main>

  <!-- MODALE ITEM (AJOUT / EDIT) -->
  <div id="item-modal" class="modal hidden" aria-modal="true" role="dialog" aria-labelledby="modal-title" tabindex="-1">
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-content">
      <button class="close-modal" id="close-modal" aria-label="Fermer la fenêtre">&times;</button>
      <h2 id="modal-title">Ajouter un élément</h2>

      <form id="item-form">
        <input type="hidden" id="item-id" />

        <!-- Catégorie -->
        <div class="form-group">
          <label for="item-type">Catégorie *</label>
          <select id="item-type" required aria-required="true"></select>
        </div>

        <!-- Titre -->
        <div class="form-group" style="position: relative;">
          <label for="item-title">Titre *</label>
          <input type="text" id="item-title" required placeholder="Ex: One Piece" aria-required="true" />
          <div id="manga-autocomplete" class="autocomplete"></div>
        </div>


        <!-- Note /10 -->
        <div class="form-group">
          <label for="item-score">Note /10 (facultatif)</label>
          <input type="number" id="item-score" min="0" max="10" step="1" value="0" />
        </div>

        <!-- Chap/Ep actuel -->
        <div class="form-group">
          <label for="item-chapter">Chap/Ep actuel</label>
          <input type="number" id="item-chapter" min="0" required value="0" aria-required="true" />
        </div>

        <!-- Chap/Ep total -->
        <div class="form-group">
          <label for="item-total">Chap/Ep total (facultatif)</label>
          <input type="number" id="item-total" min="0" value="0" />
        </div>

        <!-- Statut -->
        <div class="form-group">
          <label for="item-status">Statut</label>
          <select id="item-status">
            <option value="en-cours">En cours</option>
            <option value="termine">Terminé</option>
            <option value="pause">En pause</option>
          </select>
        </div>

        <!-- Lien -->
        <div class="form-group">
          <label for="item-url">Lien (facultatif)</label>
          <input type="url" id="item-url" placeholder="https://exemple.com" />
        </div>

        <!-- Notes personnelles -->
        <div class="form-group">
          <label for="item-notes">Notes personnelles (facultatif)</label>
          <textarea id="item-notes" rows="3" placeholder="Vos remarques, progressions, etc."
            aria-describedby="notes-help"></textarea>
        </div>

        <!-- Couverture -->
        <div class="form-group">
          <label for="item-cover">Couverture (URL) (facultatif)</label>
          <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
            <input type="url" id="item-cover" placeholder="https://.../image.jpg" aria-describedby="cover-help"
              style="flex: 1;" />
            <button type="button" id="find-cover-btn">🔍 Image</button>
          </div>
          <img id="cover-preview" class="cover-preview" alt="Aperçu de la couverture" />
          <small id="cover-help">Assurez-vous que l'URL est valide et pointe vers une image.</small>
        </div>

        <!-- Dates -->
        <div class="form-group-full">
          <div class="date-group">
            <div class="form-group">
              <label for="item-start-date">Date de début (facultatif)</label>
              <input type="date" id="item-start-date" />
            </div>
            <div class="form-group">
              <label for="item-end-date">Date de fin (facultatif)</label>
              <input type="date" id="item-end-date" />
            </div>
          </div>
        </div>

        <!-- Tags -->
        <div class="form-group">
          <label for="item-tags">Tags (séparés par des virgules, ex: action, comédie)</label>
          <input type="text" id="item-tags" placeholder="action, comédie, etc." />
        </div>
        <!-- Favori -->
        <div class="form-group" style="display:flex;align-items:center;gap:0.3rem;justify-content: center;">
          <input type="checkbox" id="item-fav" />
          <label for="item-fav">Favori</label>
        </div>
        <!-- Boutons Actions -->
        <div class="form-actions">
          <button type="submit" id="save-btn">Enregistrer</button>
          <button type="button" id="cancel-btn">Annuler</button>
        </div>


      </form>
    </div>
  </div>
  <!-- /MODALE ITEM -->

  <!-- MODALE CATEGORIES -->
  <div id="cat-modal" class="modal-cat hidden" aria-modal="true" role="dialog" aria-labelledby="cat-modal-title"
    tabindex="-1">
    <div class="modal-cat-overlay" id="cat-modal-overlay"></div>
    <div class="modal-cat-content">
      <button id="close-cat-modal" class="close-modal" aria-label="Fermer la fenêtre">&times;</button>
      <h2 id="cat-modal-title">Gérer les Catégories</h2>
      <ul id="cat-list"></ul>
      <div class="cat-actions">
        <input type="text" id="cat-input" placeholder="Nouvelle catégorie..." aria-label="Nouvelle catégorie" />
        <button class="add-cat-btn" id="add-cat-btn" aria-label="Ajouter une nouvelle catégorie">+ Ajouter</button>
      </div>
    </div>
  </div>
  <!-- /MODALE CATEGORIES -->

  <!-- MODALE STATS (GRAPHIQUES) -->

  <div id="stats-modal" class="modal-stats hidden" aria-modal="true" role="dialog" aria-labelledby="stats-modal-title"
    tabindex="-1">
    <div class="modal-stats-overlay" id="stats-modal-overlay"></div>
    <div class="modal-stats-content">
      <button id="close-stats-modal" class="close-modal" aria-label="Fermer les statistiques">&times;</button>
      <h2 id="stats-modal-title" class="stats-title">Statistiques</h2>


      <div class="stats-summary">
        <p>Total d'éléments : <span id="stats-total"></span></p>
        <p>Note moyenne : <span id="stats-average"></span>/10</p>
        <!-- Bouton pour supprimer les doublons -->
        <button id="btn-remove-duplicates" class="delete-btn" aria-label="Supprimer les doublons">
          <span>🗑️</span>
          <span>Supprimer Doublons</span>
        </button>
      </div>

      <div>
        <div class="stats-subtitle">Par Catégorie</div>
        <!-- Remplacer par un canvas -->
        <canvas id="stats-chart-cat"></canvas>
        <p class="chart-description">Répartition des éléments par catégorie.</p>
      </div>

      <div>
        <div class="stats-subtitle">Par Statut</div>
        <!-- Remplacer par un canvas -->
        <canvas id="stats-chart-status"></canvas>
        <p class="chart-description">Distribution des éléments selon leur statut.</p>
      </div>

      <!-- Item le plus avancé -->
      <div>
        <div class="stats-subtitle">Avancement max</div>
        <p id="stats-most-advanced" style="text-align:center; font-style:italic;"></p>
      </div>

      <div>
        <div class="stats-subtitle">Par Tags</div>
        <!-- Remplacer par un canvas -->
        <canvas id="stats-chart-tags"></canvas>
        <p class="chart-description">Fréquence d'utilisation des tags.</p>
      </div>
    </div>
  </div>
  <!-- /MODALE STATS -->


  <!-- TOAST NOTIFICATIONS -->
  <div id="toast-container"></div>

  <!-- SCRIPT (TOUT EN 1 FICHIER) -->
  <script>

    /****************************************************
     *                LOCAL STORAGE KEYS                *
     ****************************************************/
    const STORAGE_KEY_ITEMS = "myMiniMAL_items";
    const STORAGE_KEY_CATS = "myMiniMAL_categories";
    const STORAGE_KEY_THEME = "myMiniMAL_darkmode";
    const STORAGE_KEY_MINIMAL_VIEW = "myMiniMAL_minimalView";

    /****************************************************
     *       WELCOME SCREEN (Ne plus afficher)          *
     ****************************************************/
    const shouldShowWelcome = () => localStorage.getItem("skipWelcome") !== "true";
    const setSkipWelcome = () => localStorage.setItem("skipWelcome", "true");

    /****************************************************
     *             GESTION DES CATEGORIES               *
     ****************************************************/
    let categories = [];
    const loadCategories = () => {
      const data = localStorage.getItem(STORAGE_KEY_CATS);
      if (data) {
        categories = JSON.parse(data);
      } else {
        categories = ["Manga", "Manhwa/Manhua", "Anime", "Light Novel"];
        saveCategories();
      }
    };
    const saveCategories = () => {
      localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(categories));
    };
    const addCategory = (newCat) => {
      if (!newCat) return;
      if (!categories.includes(newCat)) {
        categories.push(newCat);
        saveCategories();
        showToast(`Catégorie "${newCat}" ajoutée.`, "success");
      } else {
        showToast(`La catégorie "${newCat}" existe déjà.`, "warning");
      }
    };
    const deleteCategory = (cat) => {
      if (categories.length === 1) {
        showToast("Vous devez conserver au moins une catégorie.", "error");
        return;
      }
      const hasItems = myList.some(item => item.type === cat);
      if (hasItems) {
        showToast(`Impossible de supprimer "${cat}" car des éléments y sont associés.`, "error");
        return;
      }
      categories = categories.filter(c => c !== cat);
      saveCategories();
      showToast(`Catégorie "${cat}" supprimée.`, "success");
    };

    /****************************************************
     *              DATA MANAGER (ITEMS)                *
     ****************************************************/
    let myList = [];
    const loadItems = () => {
      const dataStr = localStorage.getItem(STORAGE_KEY_ITEMS);
      myList = dataStr ? JSON.parse(dataStr) : [];
    };
    const saveItems = () => {
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(myList));
    };
    const addItem = (item) => {
      // Vérification des doublons avant d'ajouter
      const duplicate = myList.find(it => it.title.toLowerCase() === item.title.toLowerCase() && it.type === item.type);
      if (duplicate) {
        showToast(`L'élément "${item.title}" existe déjà dans la catégorie "${item.type}".`, "warning");
        return;
      }
      item.updatedAt = new Date().toISOString(); // Enregistre la date de création/mise à jour
      myList.push(item);
      saveItems();
      showToast(`Élément "${item.title}" ajouté.`, "success");
    };
    const updateItem = (updated) => {
      const idx = myList.findIndex(it => it.id === updated.id);
      if (idx !== -1) {
        updated.updatedAt = new Date().toISOString();
        myList[idx] = updated;
        saveItems();
        showToast(`Élément "${updated.title}" mis à jour.`, "success");
      }
    };
    const deleteItem = (id) => {
      const item = myList.find(it => it.id === id);
      if (item) {
        myList = myList.filter(it => it.id !== id);
        saveItems();
        showToast(`Élément "${item.title}" supprimé.`, "success");
      }
    };

    /****************************************************
     *          IMPORT / EXPORT DES DONNÉES             *
     ****************************************************/
    const exportDataToJSON = () => {
      const blob = new Blob([JSON.stringify({ myList, categories }, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "myMiniMAL_data.json";
      a.click();
      URL.revokeObjectURL(url);
      showToast("Données exportées avec succès.", "success");
    };

    const importDataFromJSON = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const obj = JSON.parse(e.target.result);
          if (obj.myList && obj.categories) {
            let newCats = 0;
            // 1. Fusionner les catégories
            obj.categories.forEach(cat => {
              if (!categories.includes(cat)) {
                categories.push(cat);
                newCats++;
              }
            });
            if (newCats > 0) saveCategories();

            let newItems = 0;
            let updatedItems = 0;
            // 2. Fusionner les items
            obj.myList.forEach(importedItem => {
              const existingItemIndex = myList.findIndex(it => it.id === importedItem.id);
              if (existingItemIndex === -1) {
                // Si l'item n'existe pas, l'ajouter
                myList.push(importedItem);
                newItems++;
              } else {
                // Mettre à jour l'item existant
                myList[existingItemIndex] = {
                  ...myList[existingItemIndex],
                  ...importedItem,
                  updatedAt: new Date().toISOString()
                };
                updatedItems++;
              }
            });
            if (newItems > 0 || updatedItems > 0) saveItems();

            // 3. Rafraîchir l'affichage
            populateFilterDropdown();
            renderList(getCurrentFilter());
            refreshItemTypeSelect();
            showToast(`Importation réussie !\nNouvelles catégories ajoutées : ${newCats}\nNouveaux items ajoutés : ${newItems}\nItems mis à jour : ${updatedItems}`, "success");
          } else {
            showToast("Fichier invalide (il manque myList ou categories).", "error");
          }
        } catch (error) {
          showToast("Erreur de parsing JSON : " + error, "error");
        }
      };
      reader.readAsText(file);
    };

    /****************************************************
     *       RECHERCHE, FILTRAGE ET TRI DES ITEMS        *
     ****************************************************/
    const filterByType = (type) => {
      if (type === "all") return [...myList];
      return myList.filter(it => it.type === type);
    };
    const filterBySearch = (query) => {
      const q = query.toLowerCase();
      return myList.filter(it => it.title.toLowerCase().includes(q));
    };
    const calculateProgress = (item) => {
      if (item.total > 0) {
        return Math.floor((item.chapter / item.total) * 100);
      }
      return 0;
    };
    const calculateDurationDays = (startDate, endDate) => {
      if (!startDate || !endDate) return null;
      const s = new Date(startDate);
      const e = new Date(endDate);
      const diff = e.getTime() - s.getTime();
      if (diff < 0) return null; // si endDate < startDate
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    };
    // Tri
    const sortItems = (items, mode) => {
      switch (mode) {
        case "title-asc":
          return items.sort((a, b) => a.title.localeCompare(b.title));
        case "score-desc":
          return items.sort((a, b) => (b.score || 0) - (a.score || 0));
        case "fav-first":
          return items.sort((a, b) => (b.isFav ? 1 : 0) - (a.isFav ? 1 : 0));
        case "progress-desc":
          return items.sort((a, b) => calculateProgress(b) - calculateProgress(a));
        case "recently-updated":
          return items.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        default:
          return items; // default -> ordre d'insertion
      }
    };

    /****************************************************
     *               THEME (DARK/LIGHT)                 *
     ****************************************************/
    const applyTheme = () => {
      const isDark = localStorage.getItem(STORAGE_KEY_THEME) === "true";
      document.body.classList.toggle("dark-mode", isDark);
      toggleThemeBtn.textContent = isDark ? "🌞 Light Mode" : "🌙 Dark Mode";
    };
    const toggleTheme = () => {
      const isDarkNow = document.body.classList.toggle("dark-mode");
      localStorage.setItem(STORAGE_KEY_THEME, isDarkNow ? "true" : "false");
      toggleThemeBtn.textContent = isDarkNow ? "🌞 Light Mode" : "🌙 Dark Mode";
      showToast(`Mode ${isDarkNow ? "sombre" : "clair"} activé.`, "info");
    };

    /****************************************************
     *       VUE MINIMALISTE ET PLEIN ÉCRAN IMAGES       *
     ****************************************************/
    let isMinimalView = localStorage.getItem(STORAGE_KEY_MINIMAL_VIEW) === "true";

    const applyViewSettings = () => {
      if (isMinimalView) {
        document.getElementById("list-section").classList.add("minimalist-view");
        document.querySelectorAll(".flip-card").forEach(card => card.classList.add("minimalist"));
        document.getElementById("toggle-minimal-view-btn").textContent = "🗂️ Standard";
      } else {
        document.getElementById("list-section").classList.remove("minimalist-view");
        document.querySelectorAll(".flip-card").forEach(card => card.classList.remove("minimalist"));
        document.getElementById("toggle-minimal-view-btn").textContent = "🗂️ Minimaliste";
      }
    };

    const toggleMinimalView = () => {
      isMinimalView = !isMinimalView;
      localStorage.setItem(STORAGE_KEY_MINIMAL_VIEW, isMinimalView);
      applyViewSettings();
      showToast(`Vue ${isMinimalView ? "minimaliste" : "standard"} activée.`, "info");
    };

    /****************************************************
     *            DOM ELEMENTS / INIT GLOBAL            *
     ****************************************************/
    // WELCOME
    const welcomeScreen = document.getElementById("welcome-screen");
    const dontShowAgain = document.getElementById("dont-show-again");
    const btnCloseWelcome = document.getElementById("btn-close-welcome");

    // THEME
    const toggleThemeBtn = document.getElementById("toggle-theme-btn");

    // ITEM MODAL
    const itemModal = document.getElementById("item-modal");
    const modalOverlay = document.getElementById("modal-overlay");
    const closeModalIcon = document.getElementById("close-modal");
    const cancelBtn = document.getElementById("cancel-btn");
    const itemForm = document.getElementById("item-form");
    const itemIdInput = document.getElementById("item-id");
    const itemTypeSelect = document.getElementById("item-type");
    const itemTitleInput = document.getElementById("item-title");
    const itemCoverInput = document.getElementById("item-cover");
    const itemChapInput = document.getElementById("item-chapter");
    const itemTotalInput = document.getElementById("item-total");
    const itemStatusSel = document.getElementById("item-status");
    const itemScoreInput = document.getElementById("item-score");
    const itemUrlInput = document.getElementById("item-url");
    const itemFavCheck = document.getElementById("item-fav");
    const itemNotesArea = document.getElementById("item-notes");
    const itemStartDate = document.getElementById("item-start-date");
    const itemEndDate = document.getElementById("item-end-date");
    const itemTagsInput = document.getElementById("item-tags");
    const modalTitle = document.getElementById("modal-title");
    const findCoverBtn = document.getElementById("find-cover-btn");
    const coverPreviewImg = document.getElementById("cover-preview");

    // CATS MODAL
    const catModal = document.getElementById("cat-modal");
    const catModalOverlay = document.getElementById("cat-modal-overlay");
    const closeCatModal = document.getElementById("close-cat-modal");
    const catListUl = document.getElementById("cat-list");
    const catInput = document.getElementById("cat-input");
    const addCatBtn = document.getElementById("add-cat-btn");

    // STATS MODAL
    const statsModal = document.getElementById("stats-modal");
    const statsModalOverlay = document.getElementById("stats-modal-overlay");
    const closeStatsModal = document.getElementById("close-stats-modal");
    const statsTotal = document.getElementById("stats-total");
    const statsAverage = document.getElementById("stats-average");
    const statsChartCat = document.getElementById("stats-chart-cat");
    const statsChartStatus = document.getElementById("stats-chart-status");
    const statsMostAdvanced = document.getElementById("stats-most-advanced");
    const statsChartTags = document.getElementById("stats-chart-tags");
    const btnRemoveDuplicates = document.getElementById("btn-remove-duplicates"); // Bouton pour supprimer les doublons

    // MAIN + FILTRES + TRI
    const listSection = document.getElementById("list-section");
    const filterSelect = document.getElementById("filter-select"); // Nouveau sélecteur de filtre
    const sortSelect = document.getElementById("sort-select"); // Sélecteur de tri ajouté

    // RECHERCHE
    const searchInput = document.querySelector('.search-container .search-input');
    const suggestions = document.getElementById("suggestions"); // Élément ajouté

    // IMPORT/EXPORT
    const exportBtn = document.getElementById("export-btn");
    const importFile = document.getElementById("import-file");

    // TOAST
    const toastContainer = document.getElementById("toast-container");

    // HAMBURGER MENU
    const hamburger = document.getElementById("hamburger");
    const navRight = document.querySelector(".nav-right");

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
      loadCategories();
      loadItems();
      applyTheme();
      applyViewSettings();

      initWelcome();
      populateFilterDropdown();
      initCategoryManager();
      initItemModal();
      initSearch();
      initStatsModal();
      initHamburgerMenu();

      toggleThemeBtn.addEventListener("click", toggleTheme);
      exportBtn.addEventListener("click", exportDataToJSON);
      importFile.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) {
          importDataFromJSON(e.target.files[0]);
          e.target.value = ""; // Reset input file
        }
      });
      btnRemoveDuplicates.addEventListener("click", removeDuplicates);

      // Boutons Vue Minimaliste
      document.getElementById("toggle-minimal-view-btn").addEventListener("click", toggleMinimalView);

      // Sélecteur de tri
      sortSelect.addEventListener("change", () => {
        renderList(getCurrentFilter());
      });

      // Sélecteur de filtre
      filterSelect.addEventListener("change", () => {
        renderList(filterSelect.value);
      });

      // Bouton "Ajouter"
      document.getElementById("btn-open-modal").addEventListener("click", openModalForAdd);

      renderList(getCurrentFilter());
      initDragAndDrop();
    });

    /****************************************************
     *               WELCOME SCREEN INIT                *
     ****************************************************/
    const initWelcome = () => {
      if (shouldShowWelcome()) {
        welcomeScreen.classList.remove("hidden");
        // Focus management
        welcomeScreen.focus();
      }
      btnCloseWelcome.addEventListener("click", () => {
        if (dontShowAgain.checked) {
          setSkipWelcome();
        }
        welcomeScreen.classList.add("hidden");
        // Return focus to the main content
        document.querySelector('.top-nav').focus();
      });
    };

    /****************************************************
     *               FILTRES DYNAMIQUES                 *
     ****************************************************/
    const populateFilterDropdown = () => {
      filterSelect.innerHTML = '<option value="all">Tous</option>';
      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        filterSelect.appendChild(option);
      });
    };

    /****************************************************
     *               CAT MODAL MANAGER                  *
     ****************************************************/
    const initCategoryManager = () => {
      document.getElementById("btn-manage-cats").addEventListener("click", openCatModal);
      catModalOverlay.addEventListener("click", closeCatModalFn);
      closeCatModal.addEventListener("click", closeCatModalFn);

      addCatBtn.addEventListener("click", () => {
        const newCat = catInput.value.trim();
        if (newCat) {
          addCategory(newCat);
          catInput.value = "";
          renderCatList();
          populateFilterDropdown(); // Mettre à jour le dropdown
          refreshItemTypeSelect();
          renderList(getCurrentFilter());
          catInput.focus();
        } else {
          showToast("Veuillez entrer un nom de catégorie valide.", "warning");
        }
      });

      // Permet d'ajouter une catégorie en appuyant sur "Entrée"
      catInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addCatBtn.click();
        }
      });
    };
    const openCatModal = () => {
      catModal.classList.remove("hidden");
      renderCatList();
      catInput.focus();
    };
    const closeCatModalFn = () => {
      catModal.classList.add("hidden");
      // Return focus à la gestion des catégories
      document.getElementById("btn-manage-cats").focus();
    };
    const renderCatList = () => {
      catListUl.innerHTML = "";
      categories.forEach(cat => {
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.textContent = cat;
        li.appendChild(span);

        const delBtn = document.createElement("button");
        delBtn.className = "del-cat-btn";
        delBtn.textContent = "Suppr";
        delBtn.setAttribute("aria-label", `Supprimer la catégorie ${cat}`);
        delBtn.addEventListener("click", () => {
          deleteCategory(cat);
          renderCatList();
          populateFilterDropdown(); // Mettre à jour le dropdown
          refreshItemTypeSelect();
          renderList(getCurrentFilter());
        });
        li.appendChild(delBtn);

        catListUl.appendChild(li);
      });
    };

    /****************************************************
     *             MODALE AJOUT/EDIT ITEM               *
     ****************************************************/
    const initItemModal = () => {
      closeModalIcon.addEventListener("click", closeItemModalFn);
      modalOverlay.addEventListener("click", closeItemModalFn);
      cancelBtn.addEventListener("click", closeItemModalFn);
      itemForm.addEventListener("submit", onFormSubmit);

      // Keyboard accessibility: Fermer la modale avec 'Échap'
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (!itemModal.classList.contains("hidden")) {
            closeItemModalFn();
          }
          if (!catModal.classList.contains("hidden")) {
            closeCatModalFn();
          }
          if (!statsModal.classList.contains("hidden")) {
            closeStatsModalFn();
          }
        }
      });

      refreshItemTypeSelect();
    };
    const refreshItemTypeSelect = () => {
      itemTypeSelect.innerHTML = "";
      if (categories.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucune catégorie";
        itemTypeSelect.appendChild(opt);
        itemTypeSelect.disabled = true;
        return;
      }
      itemTypeSelect.disabled = false;
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        itemTypeSelect.appendChild(opt);
      });
    };
    const openModalForAdd = () => {
      modalTitle.textContent = "Ajouter un élément";
      itemIdInput.value = "";
      if (categories.length > 0) {
        itemTypeSelect.value = categories[0];
      }
      itemTitleInput.value = "";
      itemCoverInput.value = "";
      coverPreviewImg.src = "";
      coverPreviewImg.style.display = "none";
      itemChapInput.value = 0;
      itemTotalInput.value = 0;
      itemStatusSel.value = "en-cours";
      itemScoreInput.value = 0;
      itemUrlInput.value = "";
      itemFavCheck.checked = false;
      itemNotesArea.value = "";
      itemStartDate.value = "";
      itemEndDate.value = "";
      itemTagsInput.value = "";
      itemModal.classList.remove("hidden");
      itemTitleInput.focus();
    };
    const closeItemModalFn = () => {
      itemModal.classList.add("hidden");
      // Return focus à l'ajout d'élément
      document.getElementById("btn-open-modal").focus();
    };
    const openModalForEdit = (item) => {
      modalTitle.textContent = "Modifier un élément";
      itemIdInput.value = item.id;
      itemTypeSelect.value = item.type;
      itemTitleInput.value = item.title;
      itemCoverInput.value = item.cover || "";
      if (item.cover) {
        coverPreviewImg.src = item.cover;
        coverPreviewImg.style.display = "block";
      } else {
        coverPreviewImg.src = "";
        coverPreviewImg.style.display = "none";
      }
      itemChapInput.value = item.chapter;
      itemTotalInput.value = item.total || 0;
      itemStatusSel.value = item.status || "en-cours";
      itemScoreInput.value = item.score || 0;
      itemUrlInput.value = item.url || "";
      itemFavCheck.checked = !!item.isFav;
      itemNotesArea.value = item.notes || "";
      itemStartDate.value = item.startDate || "";
      itemEndDate.value = item.endDate || "";
      itemTagsInput.value = (item.tags || []).join(", ");
      itemModal.classList.remove("hidden");
      itemTitleInput.focus();
    };
    const onFormSubmit = (e) => {
      e.preventDefault();
      const id = itemIdInput.value;
      const type = itemTypeSelect.value;
      const title = itemTitleInput.value.trim();
      const cover = itemCoverInput.value.trim();
      const chapter = parseInt(itemChapInput.value, 10) || 0;
      const total = parseInt(itemTotalInput.value, 10) || 0;
      const status = itemStatusSel.value;
      const score = parseFloat(itemScoreInput.value) || 0;
      const url = itemUrlInput.value.trim();
      const isFav = itemFavCheck.checked;
      const notes = itemNotesArea.value.trim();
      const startDate = itemStartDate.value || "";
      const endDate = itemEndDate.value || "";
      const tagsRaw = itemTagsInput.value.trim();
      const tags = tagsRaw ? tagsRaw.split(",").map(t => t.trim()).filter(Boolean) : [];

      if (!type || !title) {
        showToast("Catégorie et Titre sont obligatoires.", "warning");
        return;
      }

      if (!id) {
        // Nouveau
        const newItem = {
          id: Date.now().toString(),
          type,
          title,
          cover,
          chapter,
          total,
          status,
          score,
          url,
          isFav,
          notes,
          startDate,
          endDate,
          tags,
          updatedAt: new Date().toISOString()
        };
        addItem(newItem);
      } else {
        // Mise à jour
        const updatedItem = {
          id,
          type,
          title,
          cover,
          chapter,
          total,
          status,
          score,
          url,
          isFav,
          notes,
          startDate,
          endDate,
          tags,
          updatedAt: new Date().toISOString()
        };
        updateItem(updatedItem);
      }
      closeItemModalFn();
      renderList(getCurrentFilter());
    };

    /****************************************************
     *               RECHERCHE D'IMAGE                   *
     ****************************************************/
    // Fonction pour rechercher l'image via l'API Jikan
    const findCoverImage = async (title) => {
      const apiUrl = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1`;
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`Erreur réseau: ${response.status}`);
        }
        const data = await response.json();
        if (data.data && data.data.length > 0) {
          const anime = data.data[0];
          return anime.images.jpg.image_url; // URL de l'image de couverture
        } else {
          // Si aucun anime n'est trouvé, tenter de chercher un manga
          const mangaUrl = `https://api.jikan.moe/v4/manga?q=${encodeURIComponent(title)}&limit=1`;
          const mangaResponse = await fetch(mangaUrl);
          if (!mangaResponse.ok) {
            throw new Error(`Erreur réseau: ${mangaResponse.status}`);
          }
          const mangaData = await mangaResponse.json();
          if (mangaData.data && mangaData.data.length > 0) {
            const manga = mangaData.data[0];
            return manga.images.jpg.image_url; // URL de l'image de couverture
          } else {
            return null; // Aucune image trouvée
          }
        }
      } catch (error) {
        console.error("Erreur lors de la recherche de l'image:", error);
        showToast("Erreur lors de la recherche de l'image.", "error");
        return null;
      }
    };

    // Ajouter un écouteur d'événement pour le bouton "Trouver l'image"
    findCoverBtn.addEventListener("click", async () => {
      const title = itemTitleInput.value.trim();
      if (!title) {
        showToast("Veuillez entrer un titre avant de rechercher une image.", "warning");
        itemTitleInput.focus();
        return;
      }
      findCoverBtn.disabled = true;
      findCoverBtn.textContent = "🔍...";
      // const imageUrl = await findCoverImage(title);
      if (itemCoverInput) {
        // itemCoverInput.value = imageUrl;
        coverPreviewImg.src = itemCoverInput.value;
        coverPreviewImg.style.display = "block";
        showToast("Image trouvée et ajoutée.", "success");
      } else {
        showToast("Aucune image trouvée pour ce titre.", "warning");
        coverPreviewImg.src = "";
        coverPreviewImg.style.display = "none";
      }
      findCoverBtn.disabled = false;
      findCoverBtn.textContent = "🔍 Image";
    });


    // Afficher un aperçu de l'image de couverture lorsque l'URL est saisie manuellement
    itemCoverInput.addEventListener("input", () => {
      const url = itemCoverInput.value.trim();
      if (url) {
        coverPreviewImg.src = url;
        coverPreviewImg.style.display = "block";
      } else {
        coverPreviewImg.src = "";
        coverPreviewImg.style.display = "none";
      }
    });

    /****************************************************
     *               AFFICHAGE DE LA LISTE              *
     *           + DRAG & DROP POUR REORDONNER          *
     ****************************************************/
    const renderList = (filter = "all") => {
      listSection.innerHTML = "";
      let items = filterByType(filter);

      // Tri
      const sortMode = sortSelect.value; // Utiliser la valeur du sélecteur de tri
      items = sortItems(items, sortMode);

      // Recherche
      const query = searchInput.value.trim().toLowerCase();
      if (query) {
        items = filterBySearch(query);
      }

      if (items.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-message";
        p.textContent = "Aucun élément pour ce filtre.";
        listSection.appendChild(p);
        return;
      }
      items.forEach(it => {
        const card = createFlipCard(it);
        listSection.appendChild(card);
      });

      // Appliquer les classes selon les réglages de vue
      applyViewSettings();
    };

    const getCurrentFilter = () => {
      return filterSelect.value || "all";
    };

    const createFlipCard = (item) => {
      const flipCard = document.createElement("div");
      flipCard.className = "flip-card fade-in";
      if (isMinimalView) flipCard.classList.add("minimalist");
      flipCard.draggable = true;
      flipCard.dataset.itemId = item.id;

      const flipCardInner = document.createElement("div");
      flipCardInner.className = "flip-card-inner";

      // Face FRONT
      const front = document.createElement("div");
      front.className = "flip-card-front";

      const flipBtnFront = document.createElement("button");
      flipBtnFront.className = "flip-btn-front hidden-in-minimalist";
      flipBtnFront.innerHTML = '&#x21bb;'; // Symbole de rotation
      flipBtnFront.title = "Flip";
      flipBtnFront.addEventListener("click", () => {
        flipCardInner.classList.add("flipped");
      });
      front.appendChild(flipBtnFront);

      // Couverture
      if (item.cover) {
        const imgCover = document.createElement("img");
        imgCover.className = "cover-image";
        imgCover.src = item.cover;
        imgCover.alt = `${item.title} Cover`;
        imgCover.loading = "lazy"; // Chargement différé
        front.appendChild(imgCover);
      }

      // Titre + Note + sous-info
      const frontTop = document.createElement("div");
      frontTop.className = "front-top";

      const titleEl = document.createElement("div");
      titleEl.className = "card-title";
      titleEl.textContent = item.title;
      frontTop.appendChild(titleEl);

      // Ajout de la note sur le devant
      if (item.score) {
        const noteEl = document.createElement("div");
        noteEl.className = "note-label";
        noteEl.textContent = `Note: ${item.score}/10`;
        frontTop.appendChild(noteEl);
      }

      const statusSpan = document.createElement("span");
      statusSpan.className = `status-label ${statusClass(item.status)} hidden-in-minimalist`;
      statusSpan.textContent = statusToLabel(item.status);
      frontTop.appendChild(statusSpan);

      const subinfo = document.createElement("div");
      subinfo.className = "subinfo-front hidden-in-minimalist";
      const durationDays = calculateDurationDays(item.startDate, item.endDate);
      if (durationDays) {
        subinfo.textContent = `${item.type} | Durée: ${durationDays} j.`;
      } else {
        subinfo.textContent = `${item.type}`;
      }
      frontTop.appendChild(subinfo);

      // Favori ?
      const favContainer = document.createElement("div");
      favContainer.className = "fav-container hidden-in-minimalist";
      const favCheck = document.createElement("input");
      favCheck.type = "checkbox";
      favCheck.checked = !!item.isFav;
      favCheck.title = "Mettre en Favori";
      favCheck.addEventListener("change", () => {
        item.isFav = favCheck.checked;
        updateItem(item);
      });
      favContainer.appendChild(favCheck);
      const favLabel = document.createElement("span");
      favLabel.className = "hidden-in-minimalist"
      favLabel.textContent = "❤️";
      favContainer.appendChild(favLabel);

      frontTop.appendChild(favContainer);
      front.appendChild(frontTop);

      // **Ajout du Bouton de Lien Hypertexte**
      if (item.url) {
        const linkButton = document.createElement("a");
        linkButton.href = item.url;
        linkButton.target = "_blank"; // Ouvre le lien dans un nouvel onglet
        linkButton.className = "link-button";
        linkButton.textContent = "Voir plus";
        linkButton.setAttribute("aria-label", `Voir plus sur ${item.title}`);
        front.appendChild(linkButton); // Ajout en dernier pour positionnement
      }

      // Section des notes sur le devant
      // if (item.notes) {
      //   const notesDiv = document.createElement("div");
      //   notesDiv.className = "front-notes hidden-in-minimalist";
      //   notesDiv.textContent = `Notes: ${item.notes}`;
      //   front.appendChild(notesDiv);
      // }

      // Progress bar
      const progressBarContainer = document.createElement("div");
      progressBarContainer.className = "progress-bar-container";
      const progressBar = document.createElement("div");
      progressBar.className = "progress-bar";
      const progressValue = calculateProgress(item);
      progressBar.style.width = progressValue + "%";
      progressBarContainer.appendChild(progressBar);
      front.appendChild(progressBarContainer);

      // Stepper
      const stepper = document.createElement("div");
      stepper.className = "chap-stepper";

      const minusBtn = document.createElement("button");
      minusBtn.className = "chap-btn";
      minusBtn.innerHTML = '-'; // Symbole moins
      minusBtn.title = "Diminuer";
      minusBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Empêche le flip
        if (item.chapter > 0) {
          item.chapter--;
          updateItem(item);
          updateChapLabel(item.id, item.chapter);
        }
      });
      stepper.appendChild(minusBtn);

      const chapLabel = document.createElement("span");
      chapLabel.className = "chap-label";
      chapLabel.id = `chap-label-${item.id}`;
      chapLabel.textContent = `Ch/Ep : ${item.chapter}`;
      stepper.appendChild(chapLabel);

      const plusBtn = document.createElement("button");
      plusBtn.className = "chap-btn";
      plusBtn.innerHTML = '+'; // Symbole plus
      plusBtn.title = "Augmenter";
      plusBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Empêche le flip
        item.chapter++;
        updateItem(item);
        updateChapLabel(item.id, item.chapter);
      });
      stepper.appendChild(plusBtn);

      front.appendChild(stepper);

      // Face BACK
      const back = document.createElement("div");
      back.className = "flip-card-back";

      const flipBtnBack = document.createElement("button");
      flipBtnBack.className = "flip-btn-back";
      flipBtnBack.innerHTML = '&#x21bb;'; // Symbole de rotation
      flipBtnBack.title = "Flip";
      flipBtnBack.addEventListener("click", () => {
        flipCardInner.classList.remove("flipped");
      });
      back.appendChild(flipBtnBack);

      const backTitle = document.createElement("div");
      backTitle.className = "back-title";
      backTitle.textContent = item.title;
      back.appendChild(backTitle);

      const infoDiv = document.createElement("div");
      infoDiv.className = "back-info";
      infoDiv.innerHTML = `
        <p><strong>Score :</strong> ${item.score}/10</p>
        <div class="stars">${createStars(item.score)}</div>
      `;
      // Affiche les tags s'il y en a
      if (item.tags && item.tags.length > 0) {
        infoDiv.innerHTML += `<p><strong>Tags :</strong> ${item.tags.join(", ")}</p>`;
      }
      back.appendChild(infoDiv);

      // Notes
      if (item.notes) {
        const notesDiv = document.createElement("div");
        notesDiv.className = "notes-section";
        notesDiv.textContent = `Notes : ${item.notes}`;
        back.appendChild(notesDiv);
      }

      // Lien
      if (item.url) {
        const linkDiv = document.createElement("div");
        linkDiv.className = "link-section";
        linkDiv.innerHTML = `Lien : <a href="${item.url}" target="_blank">${item.url}</a>`;
        back.appendChild(linkDiv);
      }

      // Actions
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "actions";

      const editBtn = document.createElement("button");
      editBtn.className = "edit-btn";
      editBtn.innerHTML = '&#x270E;'; // Symbole de crayon
      editBtn.setAttribute("aria-label", `Modifier ${item.title}`);
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Empêche le flip
        openModalForEdit(item);
      });
      actionsDiv.appendChild(editBtn);

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.innerHTML = '&#x1F5D1;'; // Symbole de poubelle
      delBtn.setAttribute("aria-label", `Supprimer ${item.title}`);
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Empêche le flip
        deleteItem(item.id);
        renderList(getCurrentFilter());
      });
      actionsDiv.appendChild(delBtn);

      back.appendChild(actionsDiv);

      flipCardInner.appendChild(front);
      flipCardInner.appendChild(back);
      flipCard.appendChild(flipCardInner);

      return flipCard;
    };

    const updateChapLabel = (id, newChapter) => {
      const chapLabel = document.getElementById(`chap-label-${id}`);
      if (chapLabel) {
        const item = myList.find(it => it.id === id);
        chapLabel.textContent = `Ch/Ep : ${newChapter}`;
      }
    };

    const statusToLabel = (st) => {
      switch (st) {
        case "en-cours": return "En cours";
        case "termine": return "Terminé";
        case "pause": return "En pause";
        default: return st;
      }
    };
    const statusClass = (st) => {
      switch (st) {
        case "en-cours": return "en-cours";
        case "termine": return "termine";
        case "pause": return "pause";
        default: return "";
      }
    };
    const createStars = (score) => {
      if (!score || score <= 0) return "";
      const intScore = Math.floor(score);
      let stars = "";
      for (let i = 0; i < intScore; i++) {
        stars += "⭐";
      }
      return stars;
    };

    /****************************************************
     *           DRAG & DROP (Custom Reorder)           *
     ****************************************************/
    let dragSrcEl = null;
    const initDragAndDrop = () => {
      listSection.addEventListener("dragstart", handleDragStart);
      listSection.addEventListener("dragover", handleDragOver);
      listSection.addEventListener("drop", handleDrop);
    };
    const handleDragStart = (e) => {
      const card = e.target.closest(".flip-card");
      if (!card) return;
      dragSrcEl = card;
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/html", card.innerHTML);
      card.style.opacity = "0.4";
    };
    const handleDragOver = (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    };
    const handleDrop = (e) => {
      e.preventDefault();
      const card = e.target.closest(".flip-card");
      if (!card || card === dragSrcEl) return;
      if (dragSrcEl && card.parentNode === dragSrcEl.parentNode) {
        const children = Array.from(card.parentNode.children);
        const srcIndex = children.indexOf(dragSrcEl);
        const dropIndex = children.indexOf(card);
        if (srcIndex < dropIndex) {
          card.parentNode.insertBefore(dragSrcEl, card.nextSibling);
        } else {
          card.parentNode.insertBefore(dragSrcEl, card);
        }
        reorderList();
      }
      if (dragSrcEl) {
        dragSrcEl.style.opacity = "1";
      }
    };
    const reorderList = () => {
      const cardElems = Array.from(listSection.querySelectorAll(".flip-card"));
      const newList = [];
      cardElems.forEach(card => {
        const id = card.dataset.itemId;
        const item = myList.find(it => it.id === id);
        if (item) {
          newList.push(item);
        }
      });
      myList = newList;
      saveItems();
      showToast("Liste réordonnée.", "info");
    };

    /****************************************************
     *               RECHERCHE / AUTOCOMP               *
     ****************************************************/
    const initSearch = () => {
      searchInput.addEventListener("input", onSearchInput);
      searchInput.addEventListener("keydown", handleSearchKeyDown);
      document.addEventListener("click", (e) => {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.classList.add("hidden");
          searchInput.setAttribute("aria-expanded", "false");
        }
      });
    };
    const onSearchInput = () => {
      const query = searchInput.value.trim().toLowerCase();
      if (!query) {
        suggestions.classList.add("hidden");
        searchInput.setAttribute("aria-expanded", "false");
        renderList(getCurrentFilter());
        return;
      }
      const results = filterBySearch(query).map(it => it.title);
      if (results.length === 0) {
        suggestions.classList.add("hidden");
        listSection.innerHTML = '<p class="empty-message">Aucun titre correspondant.</p>';
        searchInput.setAttribute("aria-expanded", "false");
        return;
      }
      suggestions.innerHTML = "";
      results.slice(0, 6).forEach((title, index) => {
        const li = document.createElement("li");
        li.textContent = title;
        li.setAttribute("role", "option");
        li.setAttribute("id", `suggestion-${index}`);
        li.tabIndex = 0;
        li.addEventListener("click", () => {
          searchInput.value = title;
          suggestions.classList.add("hidden");
          searchInput.setAttribute("aria-expanded", "false");
          const item = myList.find(it => it.title.toLowerCase() === title.toLowerCase());
          if (item) {
            listSection.innerHTML = "";
            listSection.appendChild(createFlipCard(item));
            applyViewSettings();
          }
        });
        li.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            li.click();
          }
        });
        suggestions.appendChild(li);
      });
      suggestions.classList.remove("hidden");
      searchInput.setAttribute("aria-expanded", "true");
    };
    let currentFocus = -1;
    const handleSearchKeyDown = (e) => {
      const items = suggestions.getElementsByTagName("li");
      if (suggestions.classList.contains("hidden")) return;

      if (e.key === "ArrowDown") {
        currentFocus++;
        addActive(items);
        e.preventDefault();
      } else if (e.key === "ArrowUp") {
        currentFocus--;
        addActive(items);
        e.preventDefault();
      } else if (e.key === "Enter") {
        e.preventDefault();
        if (currentFocus > -1) {
          if (items[currentFocus]) {
            items[currentFocus].click();
          }
        }
      }
    };
    const addActive = (items) => {
      if (!items) return false;
      removeActive(items);
      if (currentFocus >= items.length) currentFocus = 0;
      if (currentFocus < 0) currentFocus = items.length - 1;
      items[currentFocus].classList.add("active");
      items[currentFocus].setAttribute("aria-selected", "true");
    };
    const removeActive = (items) => {
      for (let item of items) {
        item.classList.remove("active");
        item.setAttribute("aria-selected", "false");
      }
    };

    /****************************************************
     *               MODALE STATS (GRAPHIQUES)           *
     ****************************************************/
    let chartCat, chartStatus, chartTags;
    // Fonction pour générer un tableau de couleurs aléatoires
    const generateColorArray = (num) => {
      const colors = [];
      const baseColors = [
        'rgba(255, 99, 132, 0.6)',   // Rouge
        'rgba(54, 162, 235, 0.6)',   // Bleu
        'rgba(255, 206, 86, 0.6)',   // Jaune
        'rgba(75, 192, 192, 0.6)',   // Vert
        'rgba(153, 102, 255, 0.6)',  // Violet
        'rgba(255, 159, 64, 0.6)'    // Orange
      ];
      for (let i = 0; i < num; i++) {
        colors.push(baseColors[i % baseColors.length]);
      }
      return colors;
    };


    const initStatsModal = () => {
      document.getElementById("btn-show-stats").addEventListener("click", openStatsModal);
      statsModalOverlay.addEventListener("click", closeStatsModalFn);
      closeStatsModal.addEventListener("click", closeStatsModalFn);
      // Ajout de l'écouteur pour supprimer les doublons
      document.getElementById("btn-remove-duplicates").addEventListener("click", removeDuplicates);
    };
    const openStatsModal = () => {
      updateStats();
      statsModal.classList.remove("hidden");
      // Focus management
      statsModal.focus();
    };
    const closeStatsModalFn = () => {
      statsModal.classList.add("hidden");
      // Return focus au bouton d'affichage des stats
      document.getElementById("btn-show-stats").focus();
    };
    const updateStats = () => {
      // 1) Total + moyenne
      const total = myList.length;
      statsTotal.textContent = total;
      if (total === 0) {
        statsAverage.textContent = "0";
      } else {
        const avg = (myList.reduce((acc, it) => acc + (it.score || 0), 0) / total).toFixed(1);
        statsAverage.textContent = avg;
      }

      // 2) Par Catégorie
      const countsByCat = {};
      categories.forEach(cat => countsByCat[cat] = 0);
      myList.forEach(it => {
        if (!countsByCat[it.type]) countsByCat[it.type] = 0;
        countsByCat[it.type]++;
      });

      const labelsCat = Object.keys(countsByCat);
      const dataCat = Object.values(countsByCat);

      if (chartCat) chartCat.destroy(); // Détruire l'ancien graphique si existant

      chartCat = new Chart(document.getElementById('stats-chart-cat'), {
        type: 'bar',
        data: {
          labels: labelsCat,
          datasets: [{
            label: 'Nombre d\'éléments',
            data: dataCat,
            backgroundColor: 'rgba(63, 81, 181, 0.6)', // Couleur Indigo avec transparence
            borderColor: 'rgba(63, 81, 181, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // 3) Par Statut
      const allStatus = ["en-cours", "termine", "pause"];
      const countsByStatus = { "en-cours": 0, termine: 0, pause: 0 };
      myList.forEach(it => {
        if (countsByStatus[it.status] !== undefined) {
          countsByStatus[it.status]++;
        }
      });

      const labelsStatus = allStatus.map(st => statusToLabel(st));
      const dataStatus = allStatus.map(st => countsByStatus[st]);

      if (chartStatus) chartStatus.destroy();

      chartStatus = new Chart(document.getElementById('stats-chart-status'), {
        type: 'pie',
        data: {
          labels: labelsStatus,
          datasets: [{
            data: dataStatus,
            backgroundColor: [
              'rgba(56, 142, 60, 0.6)',   // Vert pour "En cours"
              'rgba(211, 47, 47, 0.6)',   // Rouge pour "Terminé"
              'rgba(251, 192, 45, 0.6)'    // Jaune pour "En pause"
            ],
            borderColor: [
              'rgba(56, 142, 60, 1)',
              'rgba(211, 47, 47, 1)',
              'rgba(251, 192, 45, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
          }
        }
      });

      // 4) Item le plus avancé
      if (myList.length > 0) {
        let maxItem = myList[0];
        myList.forEach(it => {
          if (calculateProgress(it) > calculateProgress(maxItem)) {
            maxItem = it;
          }
        });
        statsMostAdvanced.textContent = `${maxItem.title} (${calculateProgress(maxItem)}% complété)`;
      } else {
        statsMostAdvanced.textContent = "Aucun item";
      }

      // 5) Par Tags
      const tagCounts = {};
      myList.forEach(it => {
        if (it.tags && it.tags.length > 0) {
          it.tags.forEach(tag => {
            if (!tagCounts[tag]) tagCounts[tag] = 0;
            tagCounts[tag]++;
          });
        }
      });

      const labelsTags = Object.keys(tagCounts);
      const dataTags = Object.values(tagCounts);

      if (chartTags) chartTags.destroy();

      chartTags = new Chart(document.getElementById('stats-chart-tags'), {
        type: 'doughnut',
        data: {
          labels: labelsTags,
          datasets: [{
            label: 'Nombre d\'éléments par Tag',
            data: dataTags,
            backgroundColor: generateColorArray(labelsTags.length),
            borderColor: 'rgba(255, 255, 255, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
          }
        }
      });
    };


    /****************************************************
     *                  TOAST NOTIFICATIONS             *
     ****************************************************/
    let currentToast = null; // Variable pour gérer les toasts non empilés
    const showToast = (message, type = "info") => {
      // Si un toast est déjà affiché, le retirer
      if (currentToast) {
        currentToast.classList.add("hide");
        currentToast.addEventListener("animationend", () => {
          currentToast.remove();
          currentToast = null;
          createAndShowToast(message, type);
        });
      } else {
        createAndShowToast(message, type);
      }
    };
    const createAndShowToast = (message, type) => {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;

      toastContainer.appendChild(toast);
      currentToast = toast;

      // Auto-hide après 3 secondes
      setTimeout(() => {
        toast.classList.add("hide");
        toast.addEventListener("animationend", () => {
          toast.remove();
          currentToast = null;
        });
      }, 3000);
    };

    /****************************************************
     *               SUPPRESSION DES DOUBLONS            *
     ****************************************************/
    const removeDuplicates = () => {
      let duplicatesCount = 0;
      const uniqueItems = {};

      myList = myList.filter(item => {
        const key = `${item.type.toLowerCase()}-${item.title.toLowerCase()}`;
        if (uniqueItems[key]) {
          duplicatesCount++;
          return false; // Supprimer le doublon
        } else {
          uniqueItems[key] = true;
          return true;
        }
      });

      saveItems();
      renderList(getCurrentFilter());
      showToast(`Doublons supprimés : ${duplicatesCount}`, "success");
    };

    /****************************************************
     *               MENU HAMBURGER                      *
     ****************************************************/
    const initHamburgerMenu = () => {
      hamburger.addEventListener("click", toggleHamburgerMenu);
      hamburger.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleHamburgerMenu();
        }
      });
    };
    const toggleHamburgerMenu = () => {
      navRight.classList.toggle("active");
      hamburger.classList.toggle("active");
    };

    const mangaAutocomplete = document.getElementById('manga-autocomplete');
    const coverPreview = document.getElementById('cover-preview');


    // Fonction pour récupérer les mangas via l'API Jikan
    async function fetchMangaSuggestions(query) {


      let apiUrl = '';
      const itemType = itemTypeSelect.value.toLowerCase();

      if (itemType === 'light novel') {
        // Les light novels sont généralement classés sous "manga" avec le type "novel"
        apiUrl = `https://api.jikan.moe/v4/manga?q=${encodeURIComponent(query)}&limit=6`;
      }
      if (itemType === 'manhwa/manhua') {
        apiUrl = `https://api.jikan.moe/v4/manga?q=${encodeURIComponent(query)}&limit=6`;
      }
      else {
        apiUrl = `https://api.jikan.moe/v4/${itemType}?q=${encodeURIComponent(query)}&limit=6`;
      }

      try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur: ${response.status}`);
        const data = await response.json();
        return data.data;
      } catch (error) {
        console.error('Erreur de récupération des mangas:', error);
        return [];
      }
    }

    // Fonction pour afficher les suggestions
    function showAutocompleteSuggestions(items) {
      mangaAutocomplete.innerHTML = '';
      if (items.length === 0) {
        mangaAutocomplete.style.display = 'none';
        return;
      }

      items.forEach(item => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'autocomplete-item';
        suggestionDiv.innerHTML = `
                <img src="${item.images.jpg.image_url}" alt="${item.title}" />
                <span>${item.title}</span>
            `;
        suggestionDiv.addEventListener('click', () => {
          selectManga(item);
        });
        mangaAutocomplete.appendChild(suggestionDiv);
      });

      mangaAutocomplete.style.display = 'block';
    }

    // Fonction pour gérer la sélection d'un manga
    function selectManga(manga) {
      itemTitleInput.value = manga.title;
      itemCoverInput.value = manga.images.jpg.image_url;
      coverPreview.src = manga.images.jpg.image_url;
      coverPreview.alt = `Couverture de ${manga.title}`;
      mangaAutocomplete.style.display = 'none';
    }

    // Gestion de la saisie utilisateur
    itemTitleInput.addEventListener('input', async () => {
      const query = itemTitleInput.value.trim();
      // if (query.length < 2) {
      //   mangaAutocomplete.style.display = 'none';
      //   return;
      // }
      const suggestions = await fetchMangaSuggestions(query);
      showAutocompleteSuggestions(suggestions);
    });

    // Fermer l'autocomplétion en cliquant à l'extérieur
    document.addEventListener('click', (e) => {
      if (!mangaAutocomplete.contains(e.target) && e.target !== itemTitleInput) {
        mangaAutocomplete.style.display = 'none';
      }
    });

    // Mise à jour manuelle de l'aperçu de la couverture via le champ URL
    itemCoverInput.addEventListener('input', () => {
      const url = itemCoverInput.value.trim();
      if (url) {
        coverPreview.src = url;
        coverPreview.alt = "Aperçu de la couverture";
      } else {
        coverPreview.src = '';
      }
    });

  </script>
</body>

</html>